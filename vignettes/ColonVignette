---
title: "Retrofit Vignette"
author: "Roopali Singh"
date: "`r Sys.Date()`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Retrofit Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

RETROFIT is a statistical method for reference-free deconvolution of spatial transcriptomics data to estimate cell type mixtures. In this Vignette, we will estimate cell type composition of a Colon dataset. We will annotate cell types using marker gene lists. 

## Package Installation

Install and load the package using the following steps:
<!-- adam: this is not usable before submitting to and accepted by Bioconductor -->
```{r, eval=FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("retrofit")
```

```{r, load_library}
library(retrofit)
```

## Spatial Transcriptomics Data

First load the ST data, using the following command:

```{r, data}
X         =read.csv("data/colon_x.csv", row.names = 1, check.names = FALSE)
```

## Pre-processing ST data 

You may also pre-process the ST data, similar to STdeconvolve, using the following steps:
<!-- Xi: need the pre-processing steps done by Xi using STdeconvolve package -->

This code will do the following:
- remove spots with too few genes
- remove genes that are present in 100% of the spots
- remove genes that are present in less than 5% of the spots
- find over dispersed genes for deconvolution.

In the end, the ST data matrix will consist of G genes and S spots i.e., a matrix of order G x S.

## Marker genes reference for cell type annotation

Load the marker gene list:

```{r, data}
marker_ref   =read.csv("data/marker_ref.csv", row.names = 1, check.names = FALSE)
```
This file contains the list of marker genes for K = 8 cell types. Run the following command to get K cell-type mixtures from the ST data X:

## Reference-free Deconvolution along with cell type annotaion via marker genes

Initialize the requires parameters for deconvolution. We set the number of iterations, Iter = 4000 and number of components, L = 20. Lamda is kept at the default value of 0.01. K is set to be the number of cell types in the reference data i.e., K=8.
Run the following command to get K cell-type mixtures from the ST data X:

<!-- Adam: please confirm the parameter settings -->

```{r, run_retrofit}
Iter = 4000
K = 8 # number of cell types in reference
L = 20 # number of components
result = RetrofitMain(X,
                      ref_marker=marker_ref,
                      iterations=Iter, 
                      L=L, 
                      K=K,
                      seed=12)
H_annot = result["h"]
W_annot = result["w"]
```
<!-- Adam: this function should also give mapping maatrix visualization -->
We assign components to the cell type it has maximum average marker expression in as shown in figure above.

Finally, cell-type proportions for each spot in the ST data (X) are stored in H_annot of order K x S.

## Results and visualization

We can visualize the results on the tissue and check its alignment with spatial marker expression.
<!-- Roopali: I will add plotting code here -->


# Session information

```{r}
sessionInfo()
```



